<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pulse Browser</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet" />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />
  <link rel="icon" href="https://pulse.com/favicon.ico" type="image/x-icon" />
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      background: #121212;
      color: #eee;
      font-family: 'Inter', sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
      user-select: none;
    }
    /* Tabs bar */
    #tabs-bar {
      display: flex;
      background: #1f1f1f;
      border-bottom: 2px solid #e16033;
      padding-left: 1rem;
      gap: 0.5rem;
      overflow-x: auto;
    }
    .tab {
      padding: 0.5rem 1rem;
      cursor: pointer;
      background: #2a2a2a;
      border-radius: 6px 6px 0 0;
      color: #ccc;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      user-select: none;
      white-space: nowrap;
      flex-shrink: 0;
      position: relative;
      transition: background 0.2s, color 0.2s;
    }
    .tab.active {
      background: #e16033;
      color: white;
      font-weight: 600;
    }
    .tab:hover:not(.active) {
      background: #3c3c3c;
      color: #fff;
    }
    .tab .close-btn {
      font-size: 0.9rem;
      color: inherit;
      margin-left: 0.5rem;
      cursor: pointer;
      user-select: none;
    }
    .tab .close-btn:hover {
      color: #ff8c66;
    }

    header {
      padding: 1rem;
      background: #1f1f1f;
      display: flex;
      gap: 0.5rem;
      align-items: center;
      user-select: none;
      flex-wrap: wrap;
    }
    input[type="text"] {
      flex-grow: 1;
      padding: 0.5rem 1rem;
      font-size: 1rem;
      border-radius: 6px;
      border: none;
      outline: none;
      background: #2a2a2a;
      color: #eee;
      transition: background 0.2s;
      min-width: 250px;
    }
    input[type="text"]:focus {
      background: #3c3c3c;
    }
    button {
      padding: 0.5rem 1rem;
      font-size: 1.2rem;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background: #e16033;
      color: white;
      font-weight: 600;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
    }
    button:disabled {
      background: #7a3a1a;
      cursor: not-allowed;
      color: #ccc;
    }
    button:hover:not(:disabled) {
      background: #c95227;
    }
    iframe {
      flex-grow: 1;
      border: none;
      width: 100%;
      background: white;
    }
    #new-tab-btn {
      padding: 0 0.75rem;
      cursor: pointer;
      background: transparent;
      border: none;
      color: #e16033;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
      transition: color 0.2s;
      flex-shrink: 0;
    }
    #new-tab-btn:hover {
      color: #c95227;
    }
    #json-output {
      font-family: monospace;
      background: #222;
      color: #eee;
      white-space: pre-wrap;
      max-height: 250px;
      overflow-y: auto;
      padding: 1rem;
      margin: 0 1rem 1rem 1rem;
      border-radius: 6px;
      display: none;
    }
  </style>
</head>
<body>
  <!-- Tabs bar -->
  <div id="tabs-bar"></div>

  <header>
    <button id="back-btn" title="Back" disabled><i class="fa-solid fa-arrow-left"></i></button>
    <button id="forward-btn" title="Forward" disabled><i class="fa-solid fa-arrow-right"></i></button>
    <button id="reload-btn" title="Reload"><i class="fa-solid fa-rotate"></i></button>

    <input
      id="url-input"
      type="text"
      placeholder="Type a URL (like https://example.com)"
      autocomplete="off"
      spellcheck="false"
    />
    <button id="go-btn" title="Go"><i class="fa-solid fa-rocket"></i></button>

    <button id="convert-btn" title="Convert to JSON"><i class="fa-solid fa-code"></i> JSON</button>
  </header>

  <iframe
    id="browser-frame"
    src="https://pulse4web.github.io/pulse-browser//start.html"
    sandbox="allow-scripts allow-same-origin allow-forms"
  ></iframe>

  <pre id="json-output"></pre>

  <script>
    const accentColor = '#e16033';

    // Tabs state
    let tabs = [];
    let activeTabId = null;

    const tabsBar = document.getElementById('tabs-bar');
    const urlInput = document.getElementById('url-input');
    const goBtn = document.getElementById('go-btn');
    const iframe = document.getElementById('browser-frame');
    const backBtn = document.getElementById('back-btn');
    const forwardBtn = document.getElementById('forward-btn');
    const reloadBtn = document.getElementById('reload-btn');
    const convertBtn = document.getElementById('convert-btn');
    const jsonOutput = document.getElementById('json-output');

    // Generate unique tab ID
    function generateTabId() {
      return '_' + Math.random().toString(36).substr(2, 9);
    }

    function createTab(url = '/start.html') {
      const id = generateTabId();
      const tab = {
        id,
        url,
        history: [url],
        historyIndex: 0,
      };
      tabs.push(tab);
      setActiveTab(id);
      renderTabs();
    }

    function closeTab(id) {
      const idx = tabs.findIndex(t => t.id === id);
      if (idx === -1) return;

      tabs.splice(idx, 1);

      if (tabs.length === 0) {
        createTab();
        return;
      }

      if (activeTabId === id) {
        const newActiveIndex = idx === 0 ? 0 : idx - 1;
        setActiveTab(tabs[newActiveIndex].id);
      } else {
        renderTabs();
      }
    }

    function setActiveTab(id) {
      activeTabId = id;
      const tab = tabs.find(t => t.id === id);
      if (!tab) return;

      iframe.src = tab.history[tab.historyIndex];
      urlInput.value = tab.history[tab.historyIndex];
      updateNavButtons(tab);
      renderTabs();
      jsonOutput.style.display = 'none';
      jsonOutput.textContent = '';
    }

    function renderTabs() {
      tabsBar.innerHTML = '';

      tabs.forEach(tab => {
        const tabEl = document.createElement('div');
        tabEl.classList.add('tab');
        if (tab.id === activeTabId) tabEl.classList.add('active');
        tabEl.title = tab.history[tab.historyIndex];
        tabEl.textContent = tab.history[tab.historyIndex].replace(/^https?:\/\//, '').replace(/\/$/, '');

        // Close button
        const closeBtn = document.createElement('span');
        closeBtn.innerHTML = '&times;';
        closeBtn.classList.add('close-btn');
        closeBtn.onclick = e => {
          e.stopPropagation();
          closeTab(tab.id);
        };
        tabEl.appendChild(closeBtn);

        tabEl.onclick = () => setActiveTab(tab.id);

        tabsBar.appendChild(tabEl);
      });

      // New tab button
      const newTabBtn = document.createElement('button');
      newTabBtn.id = 'new-tab-btn';
      newTabBtn.title = 'New Tab';
      newTabBtn.innerHTML = '<i class="fa-solid fa-plus"></i>';
      newTabBtn.onclick = () => createTab('/start.html');
      tabsBar.appendChild(newTabBtn);
    }

    function updateNavButtons(tab) {
      backBtn.disabled = tab.historyIndex <= 0;
      forwardBtn.disabled = tab.historyIndex >= tab.history.length - 1;
    }

    function loadURL(url) {
      if (!url) return;
      if (!/^https?:\/\//i.test(url)) {
        url = 'https://' + url;
      }
      const tab = tabs.find(t => t.id === activeTabId);
      if (!tab) return;

      if (tab.historyIndex < tab.history.length - 1) {
        tab.history = tab.history.slice(0, tab.historyIndex + 1);
      }

      tab.history.push(url);
      tab.historyIndex++;
      tab.url = url;

      iframe.src = url;
      urlInput.value = url;
      updateNavButtons(tab);
      renderTabs();
      jsonOutput.style.display = 'none';
      jsonOutput.textContent = '';
    }

    goBtn.addEventListener('click', () => {
      loadURL(urlInput.value.trim());
    });

    urlInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        loadURL(urlInput.value.trim());
      }
    });

    backBtn.addEventListener('click', () => {
      const tab = tabs.find(t => t.id === activeTabId);
      if (!tab || tab.historyIndex === 0) return;
      tab.historyIndex--;
      iframe.src = tab.history[tab.historyIndex];
      urlInput.value = tab.history[tab.historyIndex];
      updateNavButtons(tab);
      renderTabs();
      jsonOutput.style.display = 'none';
      jsonOutput.textContent = '';
    });

    forwardBtn.addEventListener('click', () => {
      const tab = tabs.find(t => t.id === activeTabId);
      if (!tab || tab.historyIndex >= tab.history.length - 1) return;
      tab.historyIndex++;
      iframe.src = tab.history[tab.historyIndex];
      urlInput.value = tab.history[tab.historyIndex];
      updateNavButtons(tab);
      renderTabs();
      jsonOutput.style.display = 'none';
      jsonOutput.textContent = '';
    });

    reloadBtn.addEventListener('click', () => {
      const tab = tabs.find(t => t.id === activeTabId);
      if (!tab) return;
      iframe.src = tab.history[tab.historyIndex];
      jsonOutput.style.display = 'none';
      jsonOutput.textContent = '';
    });

    // Fetch raw HTML with CORS proxy
    async function fetchRawHTML(url) {
      const proxyUrl = 'https://api.allorigins.win/get?url=' + encodeURIComponent(url);
      const response = await fetch(proxyUrl);
      if (!response.ok) throw new Error('Failed to fetch HTML via proxy');
      const data = await response.json();

      if (!data.contents) throw new Error('No contents returned from proxy');
      return data.contents;
    }

    // Convert raw HTML to JSON using html2json API
    async function convertHTMLtoJSON(html) {
      const response = await fetch('https://html2json.com/api/v1', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ html }),
      });

      let text = await response.text();
      if (!response.ok) {
        throw new Error(`Conversion API error: ${text}`);
      }

      try {
        return JSON.parse(text);
      } catch (err) {
        throw new Error('Failed to parse API JSON response: ' + err.message);
      }
    }

    convertBtn.addEventListener('click', async () => {
      const tab = tabs.find(t => t.id === activeTabId);
      if (!tab) return alert('No active tab.');

      convertBtn.disabled = true;
      convertBtn.textContent = 'Converting...';
      jsonOutput.style.display = 'none';
      jsonOutput.textContent = '';

      try {
        const rawHTML = await fetchRawHTML(tab.history[tab.historyIndex]);
        if (!rawHTML.trim()) throw new Error('Empty HTML fetched from proxy');

        const jsonResult = await convertHTMLtoJSON(rawHTML);
        jsonOutput.textContent = JSON.stringify(jsonResult, null, 2);
        jsonOutput.style.display = 'block';
      } catch (err) {
        jsonOutput.textContent = 'Error: ' + err.message;
        jsonOutput.style.display = 'block';
        console.error(err);
      } finally {
        convertBtn.disabled = false;
        convertBtn.innerHTML = '<i class="fa-solid fa-code"></i> JSON';
      }
    });

    window.onload = () => {
      createTab('/start.html');
    };
  </script>
</body>
</html>
